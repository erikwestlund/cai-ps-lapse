---
title: "Reanalysis Step 3: Propensity Score Analysis with Twang"
subtitle: "Calculating IPTW weights using GBM across imputed datasets"
author: "Erik Westlund"
date: "`r Sys.Date()`"
format: html
---

## Setup

```{r setup}
#| include: false
source("dependencies.R")
setup_analysis(seed = 2025)

library(twang)
library(ggplot2)
library(gridExtra)
library(knitr)

# ANALYSIS MODE: Use same as imputation
analysis_mode <- "test"  # Should match imputation mode

# Set parameters based on mode
if (analysis_mode == "test") {
  max_imputations_for_diagnostics <- 2  # Show diagnostics for 2 imputations in test
  n_trees <- 1000  # Fewer trees for testing
} else {
  max_imputations_for_diagnostics <- 5  # Show diagnostics for up to 5 imputations in final
  n_trees <- 3000  # More trees for final analysis
}

```

**Analysis mode:** `r analysis_mode`  
**Will show diagnostics for up to** `r max_imputations_for_diagnostics` **imputations**  
**Using** `r n_trees` **trees for GBM**

## Load Imputed Datasets

```{r load-data}
imputed_datasets <- readRDS(file.path(reanalysis_data_dir, "imputed_datasets.rds"))
n_imputations <- length(imputed_datasets)

```

**Loaded** `r n_imputations` **imputed datasets**

```{r continue-load}

variable_lists <- readRDS(file.path(reanalysis_data_dir, "variable_lists.rds"))
```

## Define Enhanced Propensity Score Formula

```{r ps-formula}
# Original formula from get_matching_formula()
# Now enhanced to include DR severity and treatment type

# Create enhanced formula including person_dr and treatment interactions
ps_formula_enhanced <- as.formula("ever_lapse_binary ~ 
  baseline_VA_logMAR +
  gender_cat +
  race_ethnic_cat +
  insurance_cat +
  age_cat +
  CCI +
  DCSI +
  other_inject +
  anti_VEGF +
  focal_laser_flag +
  PRP_flag +
  glaucoma_bef_hitplus_cat +
  otherretina_bef_hitplus_cat +
  catsurg_before_hitplus_cat +
  person_dr +  # Added DR severity
  treatment_type  # Added treatment type
")

```

**Propensity score formula:**
```{r print-formula}
print(ps_formula_enhanced)

# Alternative: Use the standard formula from functions.R
ps_formula_standard <- get_matching_formula()

# For this analysis, we'll use the enhanced formula
ps_formula <- ps_formula_enhanced
```

## Run Twang Propensity Score Models

Following the approach in twang-analysis.Rmd, we'll use GBM via twang package to estimate propensity scores.

### Model Parameters
- **Method:** Twang GBM
- **n.trees:** Set based on analysis mode (1000 for test, 3000 for final)
- **interaction.depth:** 3
- **shrinkage:** 0.01
- **estimand:** ATT
- **stop.method:** es.mean (effect size only)

```{r ps-models}
# Initialize storage for PS results
twang_results <- list()

for (i in 1:n_imputations) {
  cat("Processing imputation", i, "of", n_imputations, "...")
  
  # Run twang ps model - following analysis.Rmd approach
  twang_model <- ps(
    formula = ps_formula,
    data = data.frame(imputed_datasets[[i]]),  # Convert to data.frame as in analysis.Rmd
    n.trees = n_trees,
    interaction.depth = 3,
    shrinkage = 0.01,
    estimand = "ATT",
    stop.method = c("es.mean"),  # Using es.mean only for speed
    verbose = FALSE
  )
  
  # Extract weights for ATT using es.mean
  weights <- get.weights(twang_model, stop.method = "es.mean")
  
  # Store results
  twang_results[[i]] <- list(
    model = twang_model,
    weights = weights,
    n_trees_used = twang_model$desc$es.mean$n.trees
  )
  
  cat("  - Trees used (es.mean):", twang_model$desc$es.mean$n.trees, "")
  cat("  - Weight range: [", round(min(weights), 3), ",", round(max(weights), 3), "]")
}

cat("Twang propensity score calculation complete")
```

## Balance Assessment

```{r balance-assessment}
# Extract balance summaries from twang models
balance_summaries <- list()

for (i in 1:n_imputations) {
  # Get the twang model
  twang_model <- twang_results[[i]]$model
  
  weights <- twang_results[[i]]$weights
  treated <- imputed_datasets[[i]]$ever_lapse_binary == 1
  
  balance_summaries[[i]] <- data.frame(
    Imputation = i,
    N_Treated = sum(treated),
    N_Control = sum(!treated),
    Mean_Weight_Treated = mean(weights[treated]),
    Mean_Weight_Control = mean(weights[!treated]),
    Max_Weight = max(weights)
  )
  
  if (i <= max_imputations_for_diagnostics) {
    cat("Balance summary for imputation", i)
    print(summary(twang_model))
  }
}

balance_summary_all <- do.call(rbind, balance_summaries)

```

### Weight Summary Across All Imputations

```{r weight-summary-table}
kable(balance_summary_all, 
      caption = "Weight distribution by imputation",
      digits = 3)

# Calculate average across imputations
avg_weights <- data.frame(
  Avg_N_Treated = mean(balance_summary_all$N_Treated),
  Avg_N_Control = mean(balance_summary_all$N_Control),
  Avg_Weight_Treated = mean(balance_summary_all$Mean_Weight_Treated),
  Avg_Weight_Control = mean(balance_summary_all$Mean_Weight_Control),
  Max_Weight_Overall = max(balance_summary_all$Max_Weight)
)

```

### Average Weights Across Imputations

```{r avg-weights-table}
kable(avg_weights,
      caption = "Average weight statistics across all imputations",
      digits = 3)

```

### Weight Stability Check

```{r weight-stability-check}
if (avg_weights$Max_Weight_Overall > 10) {
  print("Warning: Maximum weight > 10, indicating potential instability")
} else if (avg_weights$Max_Weight_Overall > 5) {
  print("Note: Maximum weight > 5, monitor for stability")
} else {
  print("Weights appear stable (max < 5)")
}
```

## Diagnostics for Sample of Imputations

```{r diagnostics-plots}
#| fig-height: 8
#| fig-width: 10

n_to_show <- min(max_imputations_for_diagnostics, n_imputations)
imps_to_show <- 1:n_to_show

cat("Generating twang diagnostic plots for", n_to_show, "imputations...")

# For each selected imputation, show twang-specific diagnostics
for (i in imps_to_show) {
  cat("Diagnostics for Imputation", i, ":")
  
  twang_model <- twang_results[[i]]$model
  
  tryCatch({
    plot(twang_model)
  }, error = function(e) {
    cat("  Standard plots not available, generating custom diagnostics...")
    
    ps_scores <- twang_results[[i]]$ps_scores
    weights <- twang_results[[i]]$weights
    treated <- imputed_datasets[[i]]$ever_lapse_binary == 1
    
    par(mfrow = c(2, 2))
    
    hist(ps_scores[!treated], main = "PS Distribution - Control", 
         xlab = "Propensity Score", col = "lightblue")
    hist(ps_scores[treated], main = "PS Distribution - Treated", 
         xlab = "Propensity Score", col = "lightcoral")
    
    hist(weights[!treated], main = "Weights - Control", 
         xlab = "Weight", col = "lightblue")
    hist(weights[treated], main = "Weights - Treated", 
         xlab = "Weight", col = "lightcoral")
    
    par(mfrow = c(1, 1))
  })
  
  print(summary(twang_model))
}
```

## Propensity Score Distribution

```{r ps-distribution}
#| fig-height: 6
#| fig-width: 10

# Plot PS distribution for first few imputations
for (i in imps_to_show) {
  cat("Propensity score distributions for imputation", i, "")
  
  twang_model <- twang_results[[i]]$model
  weights <- twang_results[[i]]$weights
  treated <- imputed_datasets[[i]]$ever_lapse_binary == 1
  
  par(mfrow = c(1, 2))
  
  # Control group weights
  hist(weights[!treated], 
       main = paste("Weights: Control - Imputation", i),
       xlab = "Weight",
       col = "lightblue",
       breaks = 20)
  
  # Treated group weights (should all be 1 for ATT)
  hist(weights[treated],
       main = paste("Weights: Treated - Imputation", i),
       xlab = "Weight", 
       col = "lightcoral",
       breaks = 20)
  
  par(mfrow = c(1, 1))
  
  cat("  Weight summary:")
  cat("    Control: mean =", round(mean(weights[!treated]), 3), 
      ", max =", round(max(weights[!treated]), 3), "")
  cat("    Treated: mean =", round(mean(weights[treated]), 3),
      "(should be 1.0 for ATT)")
}
```


## Save Propensity Score Results

```{r save-results}
ps_output <- list(
  twang_results = twang_results,
  weight_summary = balance_summary_all,
  avg_weights = avg_weights,
  formula_used = ps_formula,
  n_imputations = n_imputations,
  method = "twang_gbm",
  n_trees = n_trees,
  analysis_mode = analysis_mode
)

saveRDS(ps_output, file.path(reanalysis_data_dir, "ps_results_twang.rds"))

```

**Twang propensity score results saved to:** `r file.path(reanalysis_data_dir, "ps_results_twang.rds")`

## Summary

### Analysis Configuration

**Method:** Generalized Boosted Models (GBM) via twang  
**Estimand:** ATT (Average Treatment Effect on the Treated)  
**Stop Method:** es.mean (effect size minimization)  

```{r summary-config}
config_summary <- data.frame(
  Parameter = c("Analysis Mode", "Imputations Processed", "Trees per Model"),
  Value = c(analysis_mode, n_imputations, n_trees)
)

kable(config_summary, caption = "Run Configuration")
```

### Formula Components

The enhanced propensity score formula includes:
- DR severity (person_dr)
- Treatment type variables
- All standard covariates from original analysis

```{r summary-formula}
print(ps_formula)
```

### Weight Statistics Summary

```{r summary-weights}
weight_stats <- data.frame(
  Statistic = c("Mean Weight (Treated)", "Mean Weight (Control)", "Maximum Weight"),
  Value = c(round(avg_weights$Avg_Weight_Treated, 3),
           round(avg_weights$Avg_Weight_Control, 3),
           round(avg_weights$Max_Weight_Overall, 2))
)

kable(weight_stats, caption = "Weight Statistics (Averaged Across Imputations)")
```

#### Weight Stability Assessment

```{r weight-stability}
if (avg_weights$Max_Weight_Overall > 10) {
  print("âš  WARNING: Maximum weight > 10, indicating potential instability")
  print("Consider increasing n.trees or adjusting twang parameters")
} else if (avg_weights$Max_Weight_Overall > 5) {
  print("ðŸ“Š NOTE: Maximum weight > 5, monitor for stability in outcome analysis")
} else {
  print("âœ“ GOOD: Weights appear stable (max < 5)")
}
```

### Balance Achievement

The twang package optimizes es.mean to achieve covariate balance. Detailed balance statistics are shown in the diagnostic outputs above. Results have been saved for use in outcome analysis.

