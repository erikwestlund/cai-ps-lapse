---
title: "Reviewer Response Analysis"
author: "Erik Westlund"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Load required libraries and settings
source("settings.R")
source("functions.R")

# Load all required libraries
load_required_libraries()
```

# Data Preparation

```{r load_data}
# Load and prepare data
data_path <- file.path(s_root, "Gina's Project/df_Final_240909.csv")
data <- load_and_prepare_data(data_path)

# Apply the same exclusions as main analysis
m_data <- apply_exclusions(data)

cat(sprintf("Total observations after exclusions: %d\n", nrow(m_data)))
cat(sprintf("Total unique patients: %d\n", length(unique(m_data$e_mrn_deidentified))))
```

## Load or Generate IPTW Weights

```{r twang_weights}
# Load cached results if available
cached_results <- load_cached_results("ps_results")

# Load or generate twang weights for IPTW
if("twang_gbm" %in% names(cached_results)) {
  cat("Loading cached twang model for IPTW weights...\n")
  twang_model <- cached_results$twang_gbm$result
} else {
  cat("Running twang model to generate IPTW weights...\n")
  # Get the matching formula from functions.R
  matchingFormula <- get_matching_formula()
  
  # Run twang ps model
  library(twang)
  twang_model <- ps(
    formula = matchingFormula, 
    data = data.frame(m_data),
    n.trees = 10000,
    interaction.depth = 3,
    shrinkage = 0.01,
    estimand = "ATT",
    stop.method = c("es.mean", "ks.max")
  )
  
  # Save for future use
  if(!dir.exists("ps_results")) {
    dir.create("ps_results")
  }
  saveRDS(list(result = twang_model), file = "ps_results/twang_gbm.rds")
}

# Extract IPTW weights from twang model
m_data$twang_att_w <- get.weights(twang_model, stop.method = "es.mean")

# Summary of weights
summary(m_data$twang_att_w)
```

# Reviewer Question 1: Subgroup Testing with Formal Interaction Terms

**Reviewer Comment:** "Inadequate Subgroup Testing: Visual forest‑plot overlap doesn't prove consistent effects across subgroups (e.g., PDR+anti‑VEGF vs. PDR+PRP). Without formal interaction testing, subgroup claims lack statistical backing."

**Response:** We perform formal interaction testing using two models:
1. Interaction between lapse status and DR severity
2. Interaction between lapse status and treatment type

## Create Analysis Variables

```{r create_variables}
# Create the treatment type variable with expanded categories
m_data <- m_data |>
  mutate(
    treatment_type = case_when(
      anti_VEGF == 1 ~ "anti_VEGF",
      PRP_flag == 1 ~ "PRP",
      other_inject == 1 ~ "other_inject",
      focal_laser_flag == 1 ~ "focal_laser",
      TRUE ~ "no_treatment"
    ),
    treatment_type = factor(treatment_type, 
                           levels = c("no_treatment", "anti_VEGF", "PRP", 
                                    "other_inject", "focal_laser")),
    # Also create a severe DR indicator
    severe_dr = (NPDR == "Severe" | PDR == "Present")
  )

# Check distribution of treatment types
table(m_data$treatment_type)

# Check severe DR distribution
table(m_data$severe_dr)
```

## Define Model Formulas

```{r define_formulas}
# Define the base formula (same as analysisFormulaFull but without the outcome)
base_covariates <- c(
  "gender_cat",
  "race_ethnic_cat", 
  "insurance_cat",
  "age_cat",
  "CCI",
  "DCSI",
  "other_inject",
  "anti_VEGF",
  "focal_laser_flag",
  "PRP_flag",
  "glaucoma_bef_hitplus_cat",
  "otherretina_bef_hitplus_cat",
  "catsurg_before_hitplus_cat"
)

# Model 1: Interaction with DR severity (person_dr)
# person_dr: 0 = No DR, 1 = NPDR, 2 = PDR
interaction_dr_formula <- as.formula(paste(
  "outcome_va_vi_binary ~ ever_lapse_binary * factor(person_dr) +",
  paste(base_covariates, collapse = " + ")
))

# Model 2: Interaction with treatment type
interaction_treatment_formula <- as.formula(paste(
  "outcome_va_vi_binary ~ ever_lapse_binary * treatment_type +",
  paste(base_covariates, collapse = " + ")
))

print("DR Interaction Formula:")
print(interaction_dr_formula)

print("\nTreatment Interaction Formula:")
print(interaction_treatment_formula)
```

## Run Interaction Models

```{r interaction_models, results='asis'}
# Store results for both weighted and unweighted analyses
interaction_results_list <- list()

# Create separate data subsets for analysis
data_subsets <- list(
  all_cases = m_data,
  severe_dr_only = m_data |> filter(severe_dr == TRUE)
)

# Loop through both data subsets and both weighted and unweighted designs
for(subset_name in names(data_subsets)) {
  
  current_data <- data_subsets[[subset_name]]
  
  cat("\n\n## Data Subset:", toupper(subset_name), "\n")
  cat("Sample size:", nrow(current_data), "\n\n")
  
  # Update weights for current subset
  if("twang_att_w" %in% names(current_data)) {
    # Weights already exist from full dataset
  } else {
    current_data$twang_att_w <- m_data$twang_att_w[m_data$e_mrn_deidentified %in% current_data$e_mrn_deidentified]
  }
  
  for(weight_type in c("unweighted", "weighted")) {
  
    cat("\n### Analysis Type:", toupper(weight_type), "\n\n")
    
    # Create survey design for current subset
    current_design <- if(weight_type == "unweighted") {
      svydesign(
        ids = ~e_mrn_deidentified,
        data = current_data,
        weights = ~1
      )
    } else {
      svydesign(
        ids = ~e_mrn_deidentified,
        data = current_data,
        weights = ~twang_att_w
      )
    }
  
    # Fit Model 1: DR severity interaction
    cat("\n#### DR Severity Interaction Model\n\n")
    model_dr_interaction <- svyglm(
      formula = interaction_dr_formula,
      design = current_design,
      family = quasibinomial()
    )
    
    # Summary of DR interaction model
    summary_dr <- summary(model_dr_interaction)
    
    # Extract interaction p-values for DR model
    dr_interaction_terms <- grep("ever_lapse_binary:factor\\(person_dr\\)", 
                                names(coef(model_dr_interaction)), value = TRUE)
    dr_interaction_pvals <- if(length(dr_interaction_terms) > 0) {
      summary_dr$coefficients[dr_interaction_terms, "Pr(>|t|)"]
    } else {
      numeric(0)
    }
    
    cat("\n**DR Severity Interaction P-values:**\n\n")
    if(length(dr_interaction_terms) > 0) {
      dr_results <- data.frame(
        Term = dr_interaction_terms,
        P_Value = round(dr_interaction_pvals, 4),
        Significant = ifelse(dr_interaction_pvals < 0.05, "Yes", "No")
      )
      print(knitr::kable(dr_results))
    } else {
      cat("No interaction terms found\n")
    }
    
    # Fit Model 2: Treatment type interaction  
    cat("\n#### Treatment Type Interaction Model\n\n")
    model_treatment_interaction <- svyglm(
      formula = interaction_treatment_formula,
      design = current_design,
      family = quasibinomial()
    )
    
    # Summary of treatment interaction model
    summary_treatment <- summary(model_treatment_interaction)
    
    # Extract interaction p-values for treatment model
    treatment_interaction_terms <- grep("ever_lapse_binary:treatment_type", 
                                       names(coef(model_treatment_interaction)), value = TRUE)
    treatment_interaction_pvals <- if(length(treatment_interaction_terms) > 0) {
      summary_treatment$coefficients[treatment_interaction_terms, "Pr(>|t|)"]
    } else {
      numeric(0)
    }
    
    cat("\n**Treatment Type Interaction P-values:**\n\n")
    if(length(treatment_interaction_terms) > 0) {
      tx_results <- data.frame(
        Term = treatment_interaction_terms,
        P_Value = round(treatment_interaction_pvals, 4),
        Significant = ifelse(treatment_interaction_pvals < 0.05, "Yes", "No")
      )
      print(knitr::kable(tx_results))
    } else {
      cat("No interaction terms found\n")
    }
    
    # Store results for this weight type and subset
    if(!subset_name %in% names(interaction_results_list)) {
      interaction_results_list[[subset_name]] <- list()
    }
    interaction_results_list[[subset_name]][[weight_type]] <- list(
      dr_model = model_dr_interaction,
      treatment_model = model_treatment_interaction,
      dr_pvalues = dr_interaction_pvals,
      treatment_pvalues = treatment_interaction_pvals
    )
  } # end weight_type loop
} # end subset_name loop
```

## Summary of Interaction Tests

```{r summary_table}
# Create a comparison summary table of interaction effects
comparison_rows <- list()
for(subset_name in names(interaction_results_list)) {
  for(weight_type in c("unweighted", "weighted")) {
    subset_results <- interaction_results_list[[subset_name]][[weight_type]]
    
    comparison_rows[[paste(subset_name, weight_type, sep="_")]] <- data.frame(
      Subset = subset_name,
      Model = c("DR Severity", "Treatment Type"),
      Weight_Type = weight_type,
      N_Interactions = c(
        length(subset_results$dr_pvalues),
        length(subset_results$treatment_pvalues)
      ),
      Min_P_Value = c(
        ifelse(length(subset_results$dr_pvalues) > 0, 
               min(subset_results$dr_pvalues), NA),
        ifelse(length(subset_results$treatment_pvalues) > 0, 
               min(subset_results$treatment_pvalues), NA)
      ),
      Significant_at_05 = c(
        sum(subset_results$dr_pvalues < 0.05),
        sum(subset_results$treatment_pvalues < 0.05)
      )
    )
  }
}
comparison_results <- do.call(rbind, comparison_rows)

knitr::kable(comparison_results, 
             caption = "Summary of Interaction Test Results",
             digits = 4)
```

## Interpretation of Results

```{r interpretation}
# Check for significant interactions and report
for(subset_name in names(interaction_results_list)) {
  cat("\n### ", toupper(subset_name), "\n")
  
  # Check unweighted results
  unweighted_results <- interaction_results_list[[subset_name]][["unweighted"]]
  if(any(unweighted_results$dr_pvalues < 0.05)) {
    cat("\n**UNWEIGHTED: Significant DR severity interactions detected**\n")
    sig_terms <- names(unweighted_results$dr_pvalues)[
      unweighted_results$dr_pvalues < 0.05
    ]
    cat("Significant terms:", paste(sig_terms, collapse = ", "), "\n")
  } else {
    cat("\n**UNWEIGHTED: No significant DR severity interactions**\n")
  }
  
  if(any(unweighted_results$treatment_pvalues < 0.05)) {
    cat("\n**UNWEIGHTED: Significant treatment type interactions detected**\n")
    sig_terms <- names(unweighted_results$treatment_pvalues)[
      unweighted_results$treatment_pvalues < 0.05
    ]
    cat("Significant terms:", paste(sig_terms, collapse = ", "), "\n")
  } else {
    cat("\n**UNWEIGHTED: No significant treatment type interactions**\n")
  }
  
  # Check weighted results
  weighted_results <- interaction_results_list[[subset_name]][["weighted"]]
  if(any(weighted_results$dr_pvalues < 0.05)) {
    cat("\n**WEIGHTED (IPTW): Significant DR severity interactions detected**\n")
    sig_terms <- names(weighted_results$dr_pvalues)[
      weighted_results$dr_pvalues < 0.05
    ]
    cat("Significant terms:", paste(sig_terms, collapse = ", "), "\n")
  } else {
    cat("\n**WEIGHTED (IPTW): No significant DR severity interactions**\n")
  }
  
  if(any(weighted_results$treatment_pvalues < 0.05)) {
    cat("\n**WEIGHTED (IPTW): Significant treatment type interactions detected**\n")
    sig_terms <- names(weighted_results$treatment_pvalues)[
      weighted_results$treatment_pvalues < 0.05
    ]
    cat("Significant terms:", paste(sig_terms, collapse = ", "), "\n")
  } else {
    cat("\n**WEIGHTED (IPTW): No significant treatment type interactions**\n")
  }
}

cat("\n\n**NOTE:** Interaction p-values test whether the effect of lapsing differs")
cat("\nsignificantly across subgroups. Non-significant p-values suggest")
cat("\nconsistent effects across groups, supporting the main analysis.")
cat("\nThe IPTW-weighted analysis adjusts for confounding using propensity scores.\n")
```

# Visualization of Interaction Effects

```{r visualization_functions}
# Function to extract predicted probabilities for interaction plots
extract_predictions <- function(model, data, interaction_var, fixed_vars = NULL) {
  # Create prediction data
  pred_data <- expand.grid(
    ever_lapse_binary = c(0, 1),
    stringsAsFactors = FALSE
  )
  
  # Add the interaction variable levels
  if(interaction_var == "person_dr") {
    pred_data <- expand.grid(
      ever_lapse_binary = c(0, 1),
      person_dr = unique(data$person_dr),
      stringsAsFactors = FALSE
    )
    pred_data$person_dr <- factor(pred_data$person_dr)
  } else if(interaction_var == "treatment_type") {
    pred_data <- expand.grid(
      ever_lapse_binary = c(0, 1),
      treatment_type = levels(data$treatment_type),
      stringsAsFactors = FALSE
    )
  }
  
  # Set other variables to their reference levels or means
  for(var in all.vars(formula(model))[-1]) {
    if(!var %in% names(pred_data)) {
      if(is.factor(data[[var]]) || is.character(data[[var]])) {
        pred_data[[var]] <- factor(levels(factor(data[[var]]))[1], 
                                  levels = levels(factor(data[[var]])))
      } else {
        pred_data[[var]] <- mean(data[[var]], na.rm = TRUE)
      }
    }
  }
  
  # Get predictions
  pred_data$predicted <- predict(model, newdata = pred_data, type = "response")
  pred_data$se <- predict(model, newdata = pred_data, type = "response", se.fit = TRUE)$se.fit
  pred_data$lower <- pred_data$predicted - 1.96 * pred_data$se
  pred_data$upper <- pred_data$predicted + 1.96 * pred_data$se
  
  return(pred_data)
}
```

## DR Severity Interaction Plots

```{r dr_interaction_plots, fig.height=8}
library(ggplot2)
library(dplyr)
library(tidyr)

# Create plots for each subset and weight combination
plot_list <- list()

for(subset_name in names(interaction_results_list)) {
  for(weight_type in c("unweighted", "weighted")) {
    
    current_results <- interaction_results_list[[subset_name]][[weight_type]]
    current_data <- data_subsets[[subset_name]]
    
    # Plot 1: DR Severity Interaction
    dr_pred <- extract_predictions(current_results$dr_model, current_data, "person_dr")
    dr_pred$lapse_status <- factor(dr_pred$ever_lapse_binary, 
                                   levels = c(0, 1),
                                   labels = c("No Lapse", "Lapse"))
    dr_pred$dr_label <- factor(dr_pred$person_dr,
                               levels = c(0, 1, 2),
                               labels = c("No DR", "NPDR", "PDR"))
    
    p_dr <- ggplot(dr_pred, aes(x = dr_label, y = predicted, 
                                color = lapse_status, group = lapse_status)) +
      geom_point(position = position_dodge(0.2), size = 3) +
      geom_errorbar(aes(ymin = lower, ymax = upper), 
                   width = 0.2, position = position_dodge(0.2)) +
      geom_line(position = position_dodge(0.2), alpha = 0.5) +
      labs(title = paste("DR Severity Interaction:", subset_name, "-", weight_type),
           x = "DR Severity", 
           y = "Predicted Probability of Vision Impairment",
           color = "Lapse Status") +
      theme_minimal() +
      theme(legend.position = "bottom") +
      scale_y_continuous(limits = c(0, 1))
    
    print(p_dr)
    
    # Store plot
    plot_name_dr <- paste(subset_name, weight_type, "dr", sep = "_")
    plot_list[[plot_name_dr]] <- p_dr
  }
}
```

## Treatment Type Interaction Plots

```{r treatment_interaction_plots, fig.height=8}
for(subset_name in names(interaction_results_list)) {
  for(weight_type in c("unweighted", "weighted")) {
    
    current_results <- interaction_results_list[[subset_name]][[weight_type]]
    current_data <- data_subsets[[subset_name]]
    
    # Plot 2: Treatment Type Interaction
    tx_pred <- extract_predictions(current_results$treatment_model, current_data, "treatment_type")
    tx_pred$lapse_status <- factor(tx_pred$ever_lapse_binary,
                                   levels = c(0, 1),
                                   labels = c("No Lapse", "Lapse"))
    
    p_tx <- ggplot(tx_pred, aes(x = treatment_type, y = predicted,
                                color = lapse_status, group = lapse_status)) +
      geom_point(position = position_dodge(0.2), size = 3) +
      geom_errorbar(aes(ymin = lower, ymax = upper),
                   width = 0.2, position = position_dodge(0.2)) +
      geom_line(position = position_dodge(0.2), alpha = 0.5) +
      labs(title = paste("Treatment Type Interaction:", subset_name, "-", weight_type),
           x = "Treatment Type",
           y = "Predicted Probability of Vision Impairment",
           color = "Lapse Status") +
      theme_minimal() +
      theme(legend.position = "bottom",
            axis.text.x = element_text(angle = 45, hjust = 1)) +
      scale_y_continuous(limits = c(0, 1))
    
    print(p_tx)
    
    # Store plot
    plot_name_tx <- paste(subset_name, weight_type, "treatment", sep = "_")
    plot_list[[plot_name_tx]] <- p_tx
  }
}
```

## Forest Plot of Treatment-Specific Effects

```{r forest_plot, fig.width=12, fig.height=10}
# Extract coefficients for lapse effect in each treatment subgroup
treatment_effects <- data.frame()

for(subset_name in names(interaction_results_list)) {
  for(weight_type in c("unweighted", "weighted")) {
    model <- interaction_results_list[[subset_name]][[weight_type]]$treatment_model
    coef_summary <- summary(model)$coefficients
    
    # Get main effect
    main_effect <- coef_summary["ever_lapse_binary", "Estimate"]
    main_se <- coef_summary["ever_lapse_binary", "Std. Error"]
    
    # Get interaction effects
    interaction_terms <- grep("ever_lapse_binary:treatment_type", 
                            rownames(coef_summary), value = TRUE)
    
    for(term in interaction_terms) {
      tx_type <- gsub("ever_lapse_binary:treatment_type", "", term)
      interaction_effect <- coef_summary[term, "Estimate"]
      interaction_se <- coef_summary[term, "Std. Error"]
      
      # Combined effect = main + interaction
      combined_effect <- main_effect + interaction_effect
      combined_se <- sqrt(main_se^2 + interaction_se^2) # Approximate
      
      treatment_effects <- rbind(treatment_effects, data.frame(
        subset = subset_name,
        weight_type = weight_type,
        treatment = tx_type,
        effect = combined_effect,
        se = combined_se,
        lower = combined_effect - 1.96 * combined_se,
        upper = combined_effect + 1.96 * combined_se,
        or = exp(combined_effect),
        or_lower = exp(combined_effect - 1.96 * combined_se),
        or_upper = exp(combined_effect + 1.96 * combined_se)
      ))
    }
    
    # Add reference category (no_treatment)
    treatment_effects <- rbind(treatment_effects, data.frame(
      subset = subset_name,
      weight_type = weight_type,
      treatment = "no_treatment",
      effect = main_effect,
      se = main_se,
      lower = main_effect - 1.96 * main_se,
      upper = main_effect + 1.96 * main_se,
      or = exp(main_effect),
      or_lower = exp(main_effect - 1.96 * main_se),
      or_upper = exp(main_effect + 1.96 * main_se)
    ))
  }
}

# Create forest plot of treatment-specific effects
p_forest <- ggplot(treatment_effects, 
                  aes(x = or, y = interaction(treatment, subset, weight_type))) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = or_lower, xmax = or_upper), height = 0.2) +
  geom_vline(xintercept = 1, linetype = "dashed", alpha = 0.5) +
  labs(title = "Odds Ratios for Lapse Effect by Treatment Type",
       x = "Odds Ratio (95% CI)",
       y = "Treatment Type | Subset | Weight Type") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 8))

print(p_forest)
```

## Save Results

```{r save_results}
# Save all results for reporting
reviewer_q1_results <- list(
  unweighted = interaction_results_list$unweighted,
  weighted = interaction_results_list$weighted,
  comparison_table = comparison_results,
  twang_weights = m_data$twang_att_w,
  plots = plot_list,
  treatment_effects = treatment_effects
)

saveRDS(reviewer_q1_results, file = "reviewer_q1_interaction_results.rds")

# Save plots
for(name in names(plot_list)) {
  ggsave(paste0("interaction_plot_", name, ".png"), 
         plot_list[[name]], width = 8, height = 6, dpi = 300)
}

ggsave("interaction_forest_plot.png", p_forest, width = 12, height = 10, dpi = 300)

cat("\nResults and plots saved successfully.\n")
```

# Reviewer Question 2

*[Add content for reviewer question 2 here]*

# Reviewer Question 3  

*[Add content for reviewer question 3 here]*

# Additional Analyses

*[Add any supplementary analyses requested]*

# Summary

This analysis addresses the reviewer's concern about inadequate subgroup testing by:

1. **Formal Interaction Testing**: We tested interaction terms between lapse status and both DR severity and treatment type using survey-weighted logistic regression models.

2. **IPTW Adjustment**: We used inverse probability of treatment weighting (IPTW) from twang propensity scores to adjust for confounding.

3. **Multiple Subsets**: We analyzed both the full cohort and a subset of severe DR patients to examine whether effects differ in high-risk populations.

4. **Visualization**: We created interaction plots and forest plots to visualize how the effect of lapsing varies across subgroups.

The results from these formal interaction tests provide statistical evidence for whether the effect of lapsing on vision impairment truly differs across patient subgroups or remains consistent as suggested by the main analysis.