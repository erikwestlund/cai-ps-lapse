---
title: "Reviewer Response Analysis"
author: "Erik Westlund"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Load required libraries and settings
source("settings.R")
source("functions.R")

# Load all required libraries
load_required_libraries()
```

# Data Preparation

```{r load_data}
# Load and prepare data
data_path <- file.path(s_root, "Gina's Project/df_Final_240909.csv")
data <- load_and_prepare_data(data_path)

# Apply the same exclusions as main analysis
m_data <- apply_exclusions(data)

print(sprintf("Total observations after exclusions: %d", nrow(m_data)))
print(sprintf("Total unique patients: %d", length(unique(m_data$e_mrn_deidentified))))
```

## Load IPTW Weights from Analysis

```{r twang_weights}
# Load cached results from the main analysis pipeline
cached_results <- load_cached_results("ps_results")

# Check if twang model exists in cached results
if(!"twang_gbm" %in% names(cached_results)) {
  stop("No cached twang model found. Please run analysis.Rmd first to generate IPTW weights.")
}

print("Loading cached twang model for IPTW weights...")
twang_model <- cached_results$twang_gbm$result

# Extract IPTW weights from twang model (same as in analysis.Rmd)
m_data$twang_att_w <- get.weights(twang_model, stop.method = "es.mean")

# Summary of weights
print("Weight distribution:")
summary(m_data$twang_att_w)
```

## Main Effect of Lapsing (IPTW-Weighted)

```{r main_effect}
# Run the main model with full covariates to get the lapse effect
# Using the same formula as analysisFormulaFull from functions.R
main_formula <- get_analysis_formulas()$full

# Create weighted survey design
survey_design_weighted <- svydesign(
  ids = ~e_mrn_deidentified,
  data = m_data,
  weights = ~twang_att_w
)

# Fit the main model
main_model <- svyglm(
  formula = main_formula,
  design = survey_design_weighted,
  family = quasibinomial()
)

# Extract lapse effect
coef_summary <- summary(main_model)$coefficients
lapse_est <- coef_summary["ever_lapse_binary", "Estimate"]
lapse_se <- coef_summary["ever_lapse_binary", "Std. Error"]
lapse_p <- coef_summary["ever_lapse_binary", "Pr(>|t|)"]

# Calculate confidence intervals
lapse_ci <- confint(main_model)["ever_lapse_binary", ]

# Create results table
lapse_results <- data.frame(
  Log_Odds = round(lapse_est, 4),
  Odds_Ratio = round(exp(lapse_est), 4),
  CI_Lower = round(lapse_ci[1], 4),
  CI_Upper = round(lapse_ci[2], 4),
  P_Value = format.pval(lapse_p, digits = 4, eps = 0.0001)
)

knitr::kable(lapse_results, 
             caption = "Effect of Lapsing on Vision Impairment (IPTW-Weighted)",
             row.names = FALSE)
```

# Reviewer Question 1: Subgroup Testing with Formal Interaction Terms

**Reviewer Comment:** "Inadequate Subgroup Testing: Visual forest‑plot overlap doesn't prove consistent effects across subgroups (e.g., PDR+anti‑VEGF vs. PDR+PRP). Without formal interaction testing, subgroup claims lack statistical backing."

**Response:** We perform formal interaction testing using two models:
1. Interaction between lapse status and DR severity
2. Interaction between lapse status and treatment type

## Create Analysis Variables

```{r create_variables}
# Create the treatment type variable and properly labeled DR severity
m_data <- m_data |>
  mutate(
    treatment_type = case_when(
      anti_VEGF == 1 ~ "anti_VEGF",
      PRP_flag == 1 ~ "PRP",
      other_inject == 1 | focal_laser_flag == 1 ~ "other_treatment",
      TRUE ~ "no_treatment"
    ),
    treatment_type = factor(treatment_type, 
                           levels = c("no_treatment", "anti_VEGF", "PRP", "other_treatment")),
    # Create labeled DR severity factor for clearer interaction terms
    dr_severity = factor(person_dr,
                        levels = c(0, 1, 2),
                        labels = c("No_DR", "NPDR", "PDR"))
  )

# Check distribution of treatment types
print("Treatment Type Distribution:")
table(m_data$treatment_type)

# Display DR severity coding and distribution
print("DR Severity Distribution:")
table(m_data$dr_severity)
```

## Variable Definitions

```{r variable_definitions}
# Create a reference table for all key variables
variable_definitions <- data.frame(
  Variable = c("ever_lapse_binary", "outcome_va_vi_binary", "dr_severity", 
               "treatment_type", "person_dr", "person_dr_severity"),
  Type = c("Binary", "Binary", "Factor", "Factor", "Numeric", "Numeric"),
  Values = c("0 = No lapse, 1 = Lapsed from care",
             "0 = No vision impairment, 1 = Vision impairment (VA ≥ 0.3 logMAR)",
             "No_DR, NPDR, PDR (labeled factor for interactions)",
             "no_treatment, anti_VEGF, PRP, other_treatment",
             "0 = No DR, 1 = NPDR, 2 = PDR (numeric coding)",
             "0 = No DR, 1 = Mild NPDR, 2 = Moderate NPDR, 3 = Severe NPDR, 4 = PDR"),
  stringsAsFactors = FALSE
)

knitr::kable(variable_definitions, 
             caption = "Key Variable Definitions",
             col.names = c("Variable", "Type", "Possible Values/Coding"))
```

## Define Model Formulas

```{r define_formulas}
# Define the base formula (same as analysisFormulaFull but without the outcome)
base_covariates <- c(
  "gender_cat",
  "race_ethnic_cat", 
  "insurance_cat",
  "age_cat",
  "CCI",
  "DCSI",
  "other_inject",
  "anti_VEGF",
  "focal_laser_flag",
  "PRP_flag",
  "glaucoma_bef_hitplus_cat",
  "otherretina_bef_hitplus_cat",
  "catsurg_before_hitplus_cat"
)

# Model 1: Interaction with DR severity
# dr_severity: No_DR, NPDR, PDR
interaction_dr_formula <- as.formula(paste(
  "outcome_va_vi_binary ~ ever_lapse_binary * dr_severity +",
  paste(base_covariates, collapse = " + ")
))

# Model 2: Interaction with treatment type
interaction_treatment_formula <- as.formula(paste(
  "outcome_va_vi_binary ~ ever_lapse_binary * treatment_type +",
  paste(base_covariates, collapse = " + ")
))

print("DR Interaction Formula:")
print(interaction_dr_formula)

print("Treatment Interaction Formula:")
print(interaction_treatment_formula)
```

## Run Interaction Models (IPTW Weighted)

```{r interaction_models, results='asis'}
# Store results for weighted analyses only
interaction_results <- list()

# Create weighted survey design
survey_design_weighted <- svydesign(
  ids = ~e_mrn_deidentified,
  data = m_data,
  weights = ~twang_att_w
)

### DR Severity Interaction Model

```{r dr_interaction}
# Fit Model 1: DR severity interaction
model_dr_interaction <- svyglm(
  formula = interaction_dr_formula,
  design = survey_design_weighted,
  family = quasibinomial()
)

# Summary of DR interaction model
summary_dr <- summary(model_dr_interaction)

# Extract interaction p-values for DR model
dr_interaction_terms <- grep("ever_lapse_binary:dr_severity", 
                            names(coef(model_dr_interaction)), value = TRUE)
dr_interaction_pvals <- if(length(dr_interaction_terms) > 0) {
  summary_dr$coefficients[dr_interaction_terms, "Pr(>|t|)"]
} else {
  numeric(0)
}

# Display results
dr_results <- data.frame(
  Term = dr_interaction_terms,
  Coefficient = summary_dr$coefficients[dr_interaction_terms, "Estimate"],
  SE = summary_dr$coefficients[dr_interaction_terms, "Std. Error"],
  P_Value = round(dr_interaction_pvals, 4),
  Significant = ifelse(dr_interaction_pvals < 0.05, "Yes", "No")
)

knitr::kable(dr_results, caption = "DR Severity Interaction Terms (Individual Coefficients)")
```

## Understanding the Interaction Model

In the interaction model `outcome ~ lapse * dr_severity`, the coefficients represent:

- **Main effect of lapse (β₁)**: Effect of lapsing for the reference group (No DR)
- **Main effects of DR severity (β₂, β₃)**: Baseline differences in risk for NPDR/PDR vs No DR among non-lapsers
- **Interaction terms (β₄, β₅)**: How much the effect of lapsing differs in NPDR/PDR compared to No DR

The actual effect of lapsing within each DR group is:
- **No DR**: β₁
- **NPDR**: β₁ + β₄ 
- **PDR**: β₁ + β₅

## Joint Test of Interaction Terms

```{r joint_interaction_test}
library(car)

# Joint Wald test: Are the interaction terms jointly significant?
# H0: ever_lapse_binary:dr_severityNPDR = 0 AND ever_lapse_binary:dr_severityPDR = 0
# This tests whether the effect of lapsing is the same across all DR severity levels

joint_test <- linearHypothesis(
  model_dr_interaction,
  c("ever_lapse_binary:dr_severityNPDR = 0",
    "ever_lapse_binary:dr_severityPDR = 0"),
  vcov = vcov(model_dr_interaction)
)

# Display joint test results
joint_results <- data.frame(
  Test = "Joint interaction test",
  Chisq = round(joint_test$Chisq[2], 3),
  Df = joint_test$Df[2],
  P_Value = format.pval(joint_test$`Pr(>Chisq)`[2], digits = 4, eps = 0.0001)
)

knitr::kable(joint_results, 
             caption = "Joint Wald Test for DR Severity Interactions",
             row.names = FALSE)

# Interpret the joint test
if(joint_test$`Pr(>Chisq)`[2] < 0.05) {
  print("Joint test is significant: The effect of lapsing varies by DR severity")
} else {
  print("Joint test is not significant: The effect of lapsing is similar across DR severity levels")
}
```

## Effect of Lapsing Within Each DR Severity Group

```{r lapse_effects_by_dr}
library(emmeans)

# Calculate marginal means for each combination of lapse and DR severity
emm <- emmeans(model_dr_interaction, ~ ever_lapse_binary | dr_severity)

# Get contrasts: effect of lapse (1 vs 0) within each DR severity
lapse_contrasts <- contrast(emm, method = "revpairwise", by = "dr_severity")

# Convert to data frame and clean up
lapse_effects <- as.data.frame(lapse_contrasts)

# Create clean results table
lapse_effects_table <- data.frame(
  DR_Severity = lapse_effects$dr_severity,
  Log_Odds = round(lapse_effects$estimate, 4),
  SE = round(lapse_effects$SE, 4),
  CI_Lower = round(lapse_effects$estimate - 1.96 * lapse_effects$SE, 4),
  CI_Upper = round(lapse_effects$estimate + 1.96 * lapse_effects$SE, 4),
  Odds_Ratio = round(exp(lapse_effects$estimate), 4),
  P_Value = format.pval(lapse_effects$p.value, digits = 4, eps = 0.0001)
)

knitr::kable(lapse_effects_table,
             caption = "Effect of Lapsing Within Each DR Severity Group",
             row.names = FALSE)
```

## Complete Coefficient Interpretation

```{r coefficient_interpretation}
# Extract all coefficients for complete interpretation
all_coefs <- summary_dr$coefficients

# Create interpretation table for main effects and interactions
main_dr_coefs <- c("ever_lapse_binary", "dr_severityNPDR", "dr_severityPDR",
                   dr_interaction_terms)

interp_data <- data.frame(
  Term = character(),
  Estimate = numeric(),
  Interpretation = character(),
  stringsAsFactors = FALSE
)

# Main effect of lapse
if("ever_lapse_binary" %in% rownames(all_coefs)) {
  interp_data <- rbind(interp_data, data.frame(
    Term = "ever_lapse_binary",
    Estimate = round(all_coefs["ever_lapse_binary", "Estimate"], 4),
    Interpretation = "Effect of lapsing for No DR patients (reference group)"
  ))
}

# DR severity main effects
if("dr_severityNPDR" %in% rownames(all_coefs)) {
  interp_data <- rbind(interp_data, data.frame(
    Term = "dr_severityNPDR",
    Estimate = round(all_coefs["dr_severityNPDR", "Estimate"], 4),
    Interpretation = "Baseline difference: NPDR vs No DR (among non-lapsers)"
  ))
}

if("dr_severityPDR" %in% rownames(all_coefs)) {
  interp_data <- rbind(interp_data, data.frame(
    Term = "dr_severityPDR",
    Estimate = round(all_coefs["dr_severityPDR", "Estimate"], 4),
    Interpretation = "Baseline difference: PDR vs No DR (among non-lapsers)"
  ))
}

# Interaction terms
for(term in dr_interaction_terms) {
  if(term %in% rownames(all_coefs)) {
    dr_level <- gsub("ever_lapse_binary:dr_severity", "", term)
    interp_data <- rbind(interp_data, data.frame(
      Term = term,
      Estimate = round(all_coefs[term, "Estimate"], 4),
      Interpretation = paste("Additional effect of lapsing in", dr_level, "vs No DR")
    ))
  }
}

knitr::kable(interp_data,
             caption = "Interpretation of Model Coefficients",
             row.names = FALSE)
```

# Summary

This analysis addresses the reviewer's concern about inadequate subgroup testing by:

1. **Formal Interaction Testing**: We provide formal interaction testing between lapse status and DR severity using IPTW-weighted logistic regression models.

2. **IPTW Adjustment**: All analyses use inverse probability of treatment weighting from twang propensity scores to adjust for confounding.

3. **Clear Results**: The interaction test results provide statistical evidence for whether the effect of lapsing on vision impairment differs across DR severity levels.

The results from these formal interaction tests provide statistical evidence to address the reviewer's concern about inadequate subgroup testing.


