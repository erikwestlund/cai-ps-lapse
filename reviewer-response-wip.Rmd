---
title: "Reviewer Response Analysis - Work in Progress"
author: "Erik Westlund"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: show
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Load required libraries and settings
source("settings.R")
source("functions.R")

# Load all required libraries
load_required_libraries()
```

### Treatment Type Interaction Model

```{r treatment_interaction}
# Fit Model 2: Treatment type interaction
model_treatment_interaction <- svyglm(
  formula = interaction_treatment_formula,
  design = survey_design_weighted,
  family = quasibinomial()
)

# Summary of treatment interaction model
summary_treatment <- summary(model_treatment_interaction)

# Extract interaction p-values for treatment model
treatment_interaction_terms <- grep("ever_lapse_binary:treatment_type", 
                                   names(coef(model_treatment_interaction)), value = TRUE)
treatment_interaction_pvals <- if(length(treatment_interaction_terms) > 0) {
  summary_treatment$coefficients[treatment_interaction_terms, "Pr(>|t|)"]
} else {
  numeric(0)
}

# Display results
tx_results <- data.frame(
  Term = treatment_interaction_terms,
  Coefficient = summary_treatment$coefficients[treatment_interaction_terms, "Estimate"],
  SE = summary_treatment$coefficients[treatment_interaction_terms, "Std. Error"],
  P_Value = round(treatment_interaction_pvals, 4),
  Significant = ifelse(treatment_interaction_pvals < 0.05, "Yes", "No")
)

knitr::kable(tx_results, caption = "Treatment Type Interaction Terms")

# Store results
interaction_results <- list(
  dr_model = model_dr_interaction,
  treatment_model = model_treatment_interaction,
  dr_pvalues = dr_interaction_pvals,
  treatment_pvalues = treatment_interaction_pvals
)
```

## Summary of Interaction Tests

```{r summary_table}
# Create summary table of interaction effects
summary_results <- data.frame(
  Model = c("DR Severity", "Treatment Type"),
  N_Interactions = c(
    length(interaction_results$dr_pvalues),
    length(interaction_results$treatment_pvalues)
  ),
  Min_P_Value = c(
    ifelse(length(interaction_results$dr_pvalues) > 0, 
           min(interaction_results$dr_pvalues), NA),
    ifelse(length(interaction_results$treatment_pvalues) > 0, 
           min(interaction_results$treatment_pvalues), NA)
  ),
  Significant_at_05 = c(
    sum(interaction_results$dr_pvalues < 0.05),
    sum(interaction_results$treatment_pvalues < 0.05)
  )
)

knitr::kable(summary_results, 
             caption = "Summary of IPTW-Weighted Interaction Test Results",
             digits = 4)
```

## Key Terms and Interpretation Guide

### Understanding the Interaction Models

**What do interaction terms test?**
- Interaction p-values test whether the effect of lapsing on vision impairment differs across subgroups
- A significant interaction (p < 0.05) suggests the effect of lapsing varies by DR severity or treatment type
- Non-significant interactions suggest consistent effects across subgroups

**Variable Coding Reminder:**
- **person_dr**: 0 = No DR, 1 = NPDR (any severity), 2 = PDR
- **treatment_type**: no_treatment, anti_VEGF, PRP, other_treatment (includes other injections and focal laser)
- **ever_lapse_binary**: 0 = No lapse, 1 = Lapsed from care
- **outcome_va_vi_binary**: 0 = No vision impairment, 1 = Vision impaired (VA â‰¥ 0.3 logMAR)

## Interpretation of Results

```{r interpretation}
# Check for significant interactions and report
if(any(interaction_results$dr_pvalues < 0.05)) {
  cat("\n**Significant DR severity interactions detected**\n")
  sig_terms <- names(interaction_results$dr_pvalues)[
    interaction_results$dr_pvalues < 0.05
  ]
  cat("Significant terms:", paste(sig_terms, collapse = ", "), "\n")
} else {
  cat("\n**No significant DR severity interactions**\n")
}

if(any(interaction_results$treatment_pvalues < 0.05)) {
  cat("\n**Significant treatment type interactions detected**\n")
  sig_terms <- names(interaction_results$treatment_pvalues)[
    interaction_results$treatment_pvalues < 0.05
  ]
  cat("Significant terms:", paste(sig_terms, collapse = ", "), "\n")
} else {
  cat("\n**No significant treatment type interactions**\n")
}

cat("\n\n")
cat("**NOTE:** These IPTW-weighted analyses adjust for confounding using propensity scores. ")
cat("Non-significant interaction p-values suggest the effect of lapsing on vision impairment ")
cat("is consistent across subgroups, supporting the main analysis findings.\n")
```

# Visualization of Marginal Effects

## Calculate Marginal Effects Using Predictions

```{r marginal_effects_calculation}
library(ggplot2)
library(dplyr)

# Function to calculate marginal effects by comparing predictions
calculate_marginal_effects <- function(model, data, subgroup_var, subgroup_levels) {
  results <- data.frame()
  
  for(level in subgroup_levels) {
    # Use a smaller sample to avoid memory issues
    sample_size <- min(100, nrow(data))
    sample_data <- data[1:sample_size, ]
    
    # Create two copies for predictions
    pred_data_0 <- sample_data
    pred_data_1 <- sample_data
    
    # Set lapse status
    pred_data_0$ever_lapse_binary <- 0
    pred_data_1$ever_lapse_binary <- 1
    
    # Set the subgroup to current level
    if(subgroup_var == "person_dr") {
      pred_data_0$person_dr <- factor(level)
      pred_data_1$person_dr <- factor(level)
    } else if(subgroup_var == "treatment_type") {
      pred_data_0$treatment_type <- factor(level, levels = levels(data$treatment_type))
      pred_data_1$treatment_type <- factor(level, levels = levels(data$treatment_type))
    }
    
    # Get predictions - handle survey model output carefully
    tryCatch({
      pred_0 <- predict(model, newdata = pred_data_0, type = "response")
      pred_1 <- predict(model, newdata = pred_data_1, type = "response")
      
      # Convert to numeric vectors
      p0 <- as.numeric(as.vector(pred_0))
      p1 <- as.numeric(as.vector(pred_1))
      
      # Calculate marginal effect (average difference)
      me <- mean(p1 - p0, na.rm = TRUE)
      me_se <- sd(p1 - p0, na.rm = TRUE) / sqrt(length(p1))
      
      results <- rbind(results, data.frame(
        level = as.character(level),
        AME = me,
        SE = me_se,
        lower = me - 1.96 * me_se,
        upper = me + 1.96 * me_se
      ))
    }, error = function(e) {
      warning(paste("Error calculating marginal effect for", level, ":", e$message))
      results <- rbind(results, data.frame(
        level = as.character(level),
        AME = NA,
        SE = NA,
        lower = NA,
        upper = NA
      ))
    })
  }
  
  return(results)
}

# Calculate marginal effects for DR severity
dr_marginal_effects <- calculate_marginal_effects(
  model_dr_interaction, 
  m_data,
  "person_dr", 
  c(0, 1, 2)
)

# Add label column
dr_marginal_effects$dr_label <- factor(dr_marginal_effects$level,
                                      levels = c("0", "1", "2"),
                                      labels = c("0: No DR", "1: NPDR", "2: PDR"))

# Calculate marginal effects for treatment type
tx_marginal_effects <- calculate_marginal_effects(
  model_treatment_interaction,
  m_data,
  "treatment_type",
  levels(m_data$treatment_type)
)

# Add treatment_type column (rename level)
tx_marginal_effects$treatment_type <- tx_marginal_effects$level

# Display marginal effects tables
cat("### DR Severity - Marginal Effects of Lapsing\n")
if(nrow(dr_marginal_effects) > 0 && "dr_label" %in% names(dr_marginal_effects)) {
  print(knitr::kable(dr_marginal_effects[, c("dr_label", "AME", "SE", "lower", "upper")],
               caption = "Marginal Effect of Lapsing by DR Severity",
               digits = 4,
               row.names = FALSE))
} else {
  cat("Error calculating DR marginal effects\n")
  print(str(dr_marginal_effects))
}

cat("\n### Treatment Type - Marginal Effects of Lapsing\n")
if(nrow(tx_marginal_effects) > 0 && "treatment_type" %in% names(tx_marginal_effects)) {
  print(knitr::kable(tx_marginal_effects[, c("treatment_type", "AME", "SE", "lower", "upper")],
               caption = "Marginal Effect of Lapsing by Treatment Type", 
               digits = 4,
               row.names = FALSE))
} else {
  cat("Error calculating treatment marginal effects\n")
  print(str(tx_marginal_effects))
}
```

## Marginal Effects Plots

```{r marginal_effects_plots, fig.height=6, fig.width=10}
# Create DR severity marginal effects plot
p_dr_margins <- ggplot(dr_marginal_effects, 
                       aes(x = dr_label, y = AME)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = lower, ymax = upper), 
                width = 0.2, size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  labs(title = "Average Marginal Effect of Lapsing by DR Severity",
       subtitle = "IPTW-weighted estimates with 95% confidence intervals",
       x = "DR Severity Level",
       y = "Average Marginal Effect on P(Vision Impairment)") +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 11),
        plot.subtitle = element_text(size = 10, color = "gray40"))

print(p_dr_margins)

# Create treatment type marginal effects plot  
p_tx_margins <- ggplot(tx_marginal_effects,
                       aes(x = treatment_type, y = AME)) +
  geom_point(size = 4) +
  geom_errorbar(aes(ymin = lower, ymax = upper),
                width = 0.2, size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  labs(title = "Average Marginal Effect of Lapsing by Treatment Type",
       subtitle = "IPTW-weighted estimates with 95% confidence intervals",
       x = "Treatment Type",
       y = "Average Marginal Effect on P(Vision Impairment)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        plot.subtitle = element_text(size = 10, color = "gray40"))

print(p_tx_margins)
```

## Combined Forest Plot

```{r combined_forest_plot, fig.height=8, fig.width=10}
# Combine both marginal effects for a forest plot
dr_marginal_effects$Group <- "DR Severity"
dr_marginal_effects$Subgroup <- as.character(dr_marginal_effects$dr_label)

tx_marginal_effects$Group <- "Treatment Type"  
tx_marginal_effects$Subgroup <- as.character(tx_marginal_effects$treatment_type)

# Combine data - check that columns exist first
if(all(c("Group", "Subgroup", "AME", "SE", "lower", "upper") %in% names(dr_marginal_effects)) &&
   all(c("Group", "Subgroup", "AME", "SE", "lower", "upper") %in% names(tx_marginal_effects))) {
  combined_effects <- rbind(
    dr_marginal_effects[, c("Group", "Subgroup", "AME", "SE", "lower", "upper")],
    tx_marginal_effects[, c("Group", "Subgroup", "AME", "SE", "lower", "upper")]
  )
} else {
  # Create empty combined_effects if there's an issue
  combined_effects <- data.frame(
    Group = character(),
    Subgroup = character(),
    AME = numeric(),
    SE = numeric(),
    lower = numeric(),
    upper = numeric()
  )
  cat("Warning: Could not combine marginal effects - missing required columns\n")
}

# Create forest plot only if we have data
if(nrow(combined_effects) > 0) {
  p_forest <- ggplot(combined_effects,
                    aes(x = AME, y = reorder(paste(Group, Subgroup, sep = ": "), AME))) +
    geom_point(size = 3) +
    geom_errorbarh(aes(xmin = lower, xmax = upper), height = 0.3) +
    geom_vline(xintercept = 0, linetype = "dashed", alpha = 0.5) +
    facet_wrap(~Group, scales = "free_y", ncol = 1) +
    labs(title = "Average Marginal Effects of Lapsing Across Subgroups",
         subtitle = "IPTW-weighted estimates",
         x = "Average Marginal Effect (AME)",
         y = "") +
    theme_minimal() +
    theme(strip.text = element_text(size = 12, face = "bold"))
  
  print(p_forest)
} else {
  cat("No data available for forest plot\n")
  p_forest <- NULL
}
```

## Save Results

```{r save_final_results}
# Save all results for reporting
reviewer_q1_results <- list(
  models = interaction_results,
  dr_marginal_effects = dr_marginal_effects,
  tx_marginal_effects = tx_marginal_effects,
  combined_effects = combined_effects,
  summary_table = summary_results
)

saveRDS(reviewer_q1_results, file = "reviewer_q1_interaction_results.rds")

# Save plots if they exist
if(exists("p_dr_margins") && !is.null(p_dr_margins)) {
  ggsave("marginal_effects_dr.png", p_dr_margins, width = 10, height = 6, dpi = 300)
}
if(exists("p_tx_margins") && !is.null(p_tx_margins)) {
  ggsave("marginal_effects_treatment.png", p_tx_margins, width = 10, height = 6, dpi = 300)
}
if(exists("p_forest") && !is.null(p_forest)) {
  ggsave("marginal_effects_forest.png", p_forest, width = 10, height = 8, dpi = 300)
}

cat("\nResults and plots saved successfully.\n")
```

# Reviewer Question 2

*[Add content for reviewer question 2 here]*

# Reviewer Question 3

*[Add content for reviewer question 3 here]*

# Summary

This analysis addresses the reviewer's concern about inadequate subgroup testing by:

1. **Formal Interaction Testing**: We tested interaction terms between lapse status and both DR severity and treatment type using IPTW-weighted logistic regression models.

2. **Average Marginal Effects**: We calculated and visualized the average marginal effect of lapsing on vision impairment for each subgroup, providing interpretable effect sizes.

3. **IPTW Adjustment**: All analyses use inverse probability of treatment weighting from twang propensity scores to adjust for confounding.

4. **Clear Visualization**: Forest plots and marginal effects plots clearly show whether the effect of lapsing varies meaningfully across patient subgroups.

The results from these formal interaction tests and marginal effects analyses provide statistical evidence for whether the effect of lapsing on vision impairment truly differs across patient subgroups or remains consistent as suggested by the main analysis.