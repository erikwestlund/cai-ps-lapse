---
title: "Lapse & Vision Loss PS Analysis"
author: "Erik Westlund"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(readr)
library(dplyr)
library(kableExtra)
library(purrr)
library(gee)
library(MatchIt)

source("settings.R")

library(readr)
library(dplyr)
library(kableExtra)
library(purrr)
library(gee)
library(MatchIt)

data <- readr::read_csv(file.path(s_root, "Gina's Project/df_Final_240909.csv")) |> 
  mutate(
    outcome_va_vi = outcome_VA_logMAR >= 0.3,
    outcome_va_blind = outcome_VA_logMAR >= 1,
    ever_lapse_cat = factor(person_ever_lapse),
    MRN = dplyr::min_rank(e_mrn_deidentified),
    gender_cat = factor(gender),
    race_ethnic_cat = factor(race_ethnicity_gp),
    insurance_cat = factor(insurance_gp),
    age_cat = cut(age, breaks = c(0, 20, 45, 65, Inf), laebsl = c("0-20", "21-45", "46-65", "65+")),
    person_dr = case_when(
      No_DR == TRUE ~ 0,
      NPDR == "Mild" ~ 1,
      NPDR == "Moderate" ~ 1,
      NPDR == "Severe" ~ 1,
      PDR == "Present" ~ 2,
    ),
    person_dr_severity = case_when(
      No_DR == TRUE ~ 0,
      NPDR == "Mild" ~ 1,
      NPDR == "Moderate" ~ 2,
      NPDR == "Severe" ~ 3,
      PDR == "Present" ~ 4,
    ),
    person_ever_treat = case_when(
      other_inject == 0 & anti_VEGF == 0 & focal_laser_flag == 0 & PRP_flag == 0 ~ FALSE,
      other_inject == 1 | anti_VEGF == 1 | focal_laser_flag == 1 | PRP_flag == 1 ~ TRUE
    ),
    glaucoma_bef_hitplus_cat = case_when(
      Glaucoma_bef_hitplus != "Present" | is.na(Glaucoma_bef_hitplus) ~ FALSE,
      Glaucoma_bef_hitplus == "Present" ~ TRUE
    ),
    glaucoma_after_hitplus_cat = case_when(
      Glaucoma_after_hitplus != "Present" | is.na(Glaucoma_after_hitplus) ~ FALSE,
      Glaucoma_after_hitplus == "Present" ~ TRUE
    ),
    otherretina_bef_hitplus_cat = case_when(
      Otherretina_bef_hitplus != "Present" | is.na(Otherretina_bef_hitplus) ~ FALSE,
      Otherretina_bef_hitplus == "Present" ~ TRUE
    ),
    glaucoma_after_hitplus_cat = case_when(
      Otherretina_after_hitplus != "Present" | is.na(Otherretina_after_hitplus) ~ FALSE,
      Otherretina_after_hitplus == "Present" ~ TRUE
    )
  ) |> 
  rename(
    catsurg_before_hitplus_cat = cataract_surgery_bef_hitplus,
    catsurg_after_hitplus_cat = cataract_surgery_after_hitplus,
  )

```

## Goals

`Treatment`: We consider here the "treatment" to be having a lapsed episode within our observation window.
`Outcome`: We want to estimate the effect of the treatment on vision loss, measured separately as vision impairment and blindness.
`Estimand`: We will estimate the ATT, or average treatment effect in the treated. 

In summary, we will attempt to estimate the effect of lapsing vs. not lapsing among those who lapsed. Put differently, one could think of this as the impact of attending clinic, counter to fact (lapsing), on vision impairment.

## Process

We will use propensity score matching techniques to estimate the probability of treatment (i.e., the probability of lapsing), given a vector of covariates. These covariates must be measured before treatment. We will then use these probabilities, or propensity scores, to construct a cohort of patients.

Since we will be estimating the `ATT`, all patients who lapsed will be kept in the study. We will use various techniques to choose a matched cohort of patients, with the end goal of matching lapsers with patients who do not lapse, despite having a similar propensity to do so.

## Issues

10 People are missing CCI and DCSI:

```{r cci}
missing <- data |> 
  select(e_mrn_deidentified, CCI, DCSI) |> 
  filter(is.na(CCI) | is.na(DCSI))

missing |> count()
missing |> kable()


m_data <- data |> 
  filter(!is.na(CCI) & !is.na(DCSI))
```

## Propensity Score Construction

```{r match_1}

m.out1 <- matchit(
  ever_lapse_cat ~ 
    baseline_VA_logMAR +
    gender_cat +
    race_ethnic_cat +
    insurance_cat +
    age_cat +
    CCI +
    DCSI +
    other_inject +
    anti_VEGF +
    focal_laser_flag +
    PRP_flag +
    glaucoma_bef_hitplus_cat +
    glaucoma_after_hitplus_cat +
    otherretina_bef_hitplus_cat +
    glaucoma_after_hitplus_cat +
    catsurg_before_hitplus_cat +
    catsurg_after_hitplus_cat,
    data = m_data,
    method = "optimal",
    distance = "glm",
    estimate = "ATT", 
  )


m.out1
summary(m.out1)
plot(m.out1, type = "jitter", interactive = FALSE)
plot(m.out1, type = "desnity", interactive = FALSE, which.xs = ~baseline_VA_logMAR + CCI + DCSI)
plot(m.out1, type = "jitter", interactive = FALSE)

```

For now, I am dropping these cases. I assume we can fill them back in since we should have the information to do so.

## Variable qusetions:

Confirm time of measurement (i.e., was it before measurement of lapse) on the following measures:

* `other_inject`
* `anti_VEGF`
* `focal_laser_flag`
* `PRP_flag`
* `glaucoma_bef_hitplus_cat`
* `glaucoma_after_hitplus_cat`
* `otherretina_bef_hitplus_cat`
* `glaucoma_after_hitplus_cat`
* `catsurg_before_hitplus_cat`
* `catsurg_after_hitplus_cat`