---
title: "Step 14: Export All Results"
subtitle: "Export pooled PS results, marginal effects, and forest plots to various formats"
author: "Analysis Team"
date: "`r Sys.Date()`"
format:
  html:
    toc: true
    toc-depth: 2
    code-fold: true
    code-summary: "Show code"
    embed-resources: true
    self-contained: true
---

## Setup

```{r setup}
#| include: false
source("dependencies.R")
source("functions.R")
source("alt_specs.R")
setup_analysis(seed = 2025)

library(knitr)
library(kableExtra)

# Initialize logging
log_file <- init_log("export_results")
log_message("Starting results export")

# Configuration
pooled_cache_dir <- file.path(reanalysis_data_dir, "ps_cache", "pooled_results")
marginal_effects_dir <- file.path(reanalysis_data_dir, "marginal_effects_cache")
forest_plots_dir <- file.path(reanalysis_data_dir, "forest_plots")
export_dir <- file.path(reanalysis_data_dir, "exported_results")

# Create export directory if it doesn't exist
if (!dir.exists(export_dir)) {
  dir.create(export_dir, recursive = TRUE)
  log_message(paste0("Created export directory: ", export_dir))
}
```

## Load All Results

```{r load-results}
# Load PS methods pooled results
pooled_results_file <- file.path(pooled_cache_dir, "all_pooled_results.rds")

if (file.exists(pooled_results_file)) {
  pooled_results <- readRDS(pooled_results_file)
  log_message(paste0("Loaded pooled PS results for ", length(pooled_results), " methods"))
} else {
  cat("Warning: PS pooled results not found. Run reanalysis-10-pooling_results.qmd first\n")
  pooled_results <- list()
}

# Load marginal effects results
mfx_results_file <- file.path(marginal_effects_dir, "pooled_mfx_results.rds")

if (file.exists(mfx_results_file)) {
  pooled_mfx <- readRDS(mfx_results_file)
  log_message(paste0("Loaded marginal effects for ", length(pooled_mfx), " subgroups"))
} else {
  cat("Warning: Marginal effects results not found. Run reanalysis-12-marginal_effects.qmd first\n")
  pooled_mfx <- list()
}

# Check for forest plots
forest_plot_files <- list.files(forest_plots_dir, pattern = "\\.png$", full.names = TRUE)
if (length(forest_plot_files) > 0) {
  log_message(paste0("Found ", length(forest_plot_files), " forest plot files"))
} else {
  cat("Warning: No forest plots found. Run reanalysis-13-forest_plots.qmd first\n")
}
```

## Export 1: Main Results Table (CSV)

```{r export-main-csv}
# Convert nested list to data frame
results_df <- do.call(rbind, lapply(names(pooled_results), function(method_name) {
  res <- pooled_results[[method_name]]
  if (res$success) {
    data.frame(
      method = method_name,
      log_or = res$estimate,
      se = res$se,
      or = res$or,
      ci_lower_log = res$ci_lower,
      ci_upper_log = res$ci_upper,
      or_ci_lower = res$or_ci_lower,
      or_ci_upper = res$or_ci_upper,
      p_value = res$p_value,
      n_imputations = res$n_imputations,
      df = res$df,
      stringsAsFactors = FALSE
    )
  } else {
    data.frame(
      method = method_name,
      log_or = NA,
      se = NA,
      or = NA,
      ci_lower_log = NA,
      ci_upper_log = NA,
      or_ci_lower = NA,
      or_ci_upper = NA,
      p_value = NA,
      n_imputations = NA,
      df = NA,
      stringsAsFactors = FALSE
    )
  }
}))

# Sort by OR for better readability
results_df <- results_df[order(results_df$or, na.last = TRUE), ]

# Add rank column
results_df$rank <- seq_len(nrow(results_df))

# Reorder columns
results_df <- results_df[, c("rank", "method", "or", "or_ci_lower", "or_ci_upper", 
                              "p_value", "log_or", "se", "ci_lower_log", "ci_upper_log",
                              "n_imputations", "df")]

# Display the table
kable(results_df[, c("rank", "method", "or", "or_ci_lower", "or_ci_upper", "p_value", "n_imputations")],
      caption = "Pooled Results Summary",
      col.names = c("Rank", "Method", "OR", "Lower CI", "Upper CI", "P-value", "N Imp"),
      digits = c(0, 0, 3, 3, 3, 4, 0),
      align = c("c", "l", "r", "r", "r", "r", "c"))

# Save to CSV
csv_file <- file.path(export_dir, "pooled_results_main.csv")
write.csv(results_df, csv_file, row.names = FALSE)
log_message(paste0("Exported main results to: ", csv_file))
cat("\nMain results exported to:", csv_file, "\n")
```

## Export 2: Publication-Ready Table (CSV)

```{r export-publication-csv}
# Create publication-ready format with formatted strings
pub_df <- data.frame(
  Method = results_df$method,
  `Odds Ratio` = sprintf("%.3f", results_df$or),
  `95% CI` = sprintf("(%.3f, %.3f)", results_df$or_ci_lower, results_df$or_ci_upper),
  `P-value` = ifelse(results_df$p_value < 0.001, "<0.001", sprintf("%.3f", results_df$p_value)),
  `N Imputations` = results_df$n_imputations,
  stringsAsFactors = FALSE
)

# Add significance stars
pub_df$Significance <- ifelse(results_df$p_value < 0.001, "***",
                              ifelse(results_df$p_value < 0.01, "**",
                                    ifelse(results_df$p_value < 0.05, "*", "")))

# Display
kable(pub_df,
      caption = "Publication-Ready Results Table",
      col.names = c("Method", "OR", "95% CI", "P-value", "N", "Sig"))

# Save to CSV
pub_csv_file <- file.path(export_dir, "pooled_results_publication.csv")
write.csv(pub_df, pub_csv_file, row.names = FALSE)
log_message(paste0("Exported publication table to: ", pub_csv_file))
cat("\nPublication table exported to:", pub_csv_file, "\n")
```

## Export 3: Method Comparison (CSV)

```{r export-comparison}
# Use twang_gbm as reference if available
reference_method <- if ("twang_gbm" %in% results_df$method) "twang_gbm" else results_df$method[1]
ref_or <- results_df$or[results_df$method == reference_method]

# Calculate relative differences
comparison_df <- data.frame(
  method = results_df$method,
  or = results_df$or,
  or_ci = sprintf("(%.3f, %.3f)", results_df$or_ci_lower, results_df$or_ci_upper),
  p_value = results_df$p_value,
  relative_to_ref = results_df$or / ref_or,
  percent_diff = 100 * (results_df$or / ref_or - 1),
  abs_diff = results_df$or - ref_or,
  stringsAsFactors = FALSE
)

# Sort by relative difference
comparison_df <- comparison_df[order(comparison_df$relative_to_ref), ]

# Display
kable(comparison_df[, c("method", "or", "relative_to_ref", "percent_diff")],
      caption = paste0("Method Comparison (Reference: ", reference_method, ")"),
      col.names = c("Method", "OR", "Relative to Ref", "% Difference"),
      digits = c(0, 3, 3, 1),
      align = c("l", "r", "r", "r"))

# Save to CSV
comp_csv_file <- file.path(export_dir, paste0("method_comparison_vs_", reference_method, ".csv"))
write.csv(comparison_df, comp_csv_file, row.names = FALSE)
log_message(paste0("Exported comparison to: ", comp_csv_file))
cat("\nMethod comparison exported to:", comp_csv_file, "\n")
```

## Export 4: Summary Statistics (TXT)

```{r export-summary}
# Create summary text file
summary_lines <- c(
  "================================================================================",
  "PROPENSITY SCORE METHODS - POOLED RESULTS SUMMARY",
  "================================================================================",
  paste0("Generated: ", Sys.Date()),
  paste0("Analysis: Multiple Imputation with Rubin's Rules"),
  "",
  "METHODS ANALYZED:",
  paste0("  Total methods: ", nrow(results_df)),
  paste0("  Successful pooling: ", sum(!is.na(results_df$or))),
  paste0("  Failed pooling: ", sum(is.na(results_df$or))),
  "",
  "EFFECT SIZE SUMMARY:",
  paste0("  Minimum OR: ", sprintf("%.3f", min(results_df$or, na.rm = TRUE)),
         " (", results_df$method[which.min(results_df$or)], ")"),
  paste0("  Maximum OR: ", sprintf("%.3f", max(results_df$or, na.rm = TRUE)),
         " (", results_df$method[which.max(results_df$or)], ")"),
  paste0("  Median OR: ", sprintf("%.3f", median(results_df$or, na.rm = TRUE))),
  paste0("  Mean OR: ", sprintf("%.3f", mean(results_df$or, na.rm = TRUE))),
  paste0("  SD of ORs: ", sprintf("%.3f", sd(results_df$or, na.rm = TRUE))),
  "",
  "STATISTICAL SIGNIFICANCE:",
  paste0("  P < 0.05: ", sum(results_df$p_value < 0.05, na.rm = TRUE), " methods"),
  paste0("  P < 0.01: ", sum(results_df$p_value < 0.01, na.rm = TRUE), " methods"),
  paste0("  P < 0.001: ", sum(results_df$p_value < 0.001, na.rm = TRUE), " methods"),
  "",
  "REFERENCE METHOD (twang_gbm):"
)

if ("twang_gbm" %in% results_df$method) {
  twang_row <- results_df[results_df$method == "twang_gbm", ]
  summary_lines <- c(summary_lines,
    paste0("  OR: ", sprintf("%.3f", twang_row$or)),
    paste0("  95% CI: (", sprintf("%.3f", twang_row$or_ci_lower), 
           ", ", sprintf("%.3f", twang_row$or_ci_upper), ")"),
    paste0("  P-value: ", sprintf("%.4f", twang_row$p_value)),
    "",
    "METHODS WITHIN 10% OF REFERENCE:",
    paste0("  ", sum(abs(results_df$or / twang_row$or - 1) <= 0.10, na.rm = TRUE),
           " of ", sum(!is.na(results_df$or)), " methods")
  )
} else {
  summary_lines <- c(summary_lines, "  twang_gbm not found in results")
}

summary_lines <- c(summary_lines,
  "",
  "TOP 3 METHODS BY EFFECT SIZE:",
  paste0("  1. ", results_df$method[nrow(results_df)], 
         " (OR = ", sprintf("%.3f", results_df$or[nrow(results_df)]), ")"),
  paste0("  2. ", results_df$method[nrow(results_df)-1], 
         " (OR = ", sprintf("%.3f", results_df$or[nrow(results_df)-1]), ")"),
  paste0("  3. ", results_df$method[nrow(results_df)-2], 
         " (OR = ", sprintf("%.3f", results_df$or[nrow(results_df)-2]), ")"),
  "",
  "================================================================================",
  "END OF SUMMARY",
  "================================================================================"
)

# Display summary
cat(paste(summary_lines, collapse = "\n"))

# Save to text file
summary_file <- file.path(export_dir, "results_summary.txt")
writeLines(summary_lines, summary_file)
log_message(paste0("Exported summary to: ", summary_file))
cat("\n\nSummary exported to:", summary_file, "\n")
```

## Export 5: Excel Workbook (Multiple Sheets)

```{r export-excel}
#| eval: false
# Note: Set eval: true if openxlsx package is available

library(openxlsx)

# Create workbook
wb <- createWorkbook()

# Sheet 1: Main Results
addWorksheet(wb, "Main Results")
writeData(wb, "Main Results", results_df)

# Sheet 2: Publication Format
addWorksheet(wb, "Publication")
writeData(wb, "Publication", pub_df)

# Sheet 3: Method Comparison
addWorksheet(wb, "Comparison")
writeData(wb, "Comparison", comparison_df)

# Sheet 4: Summary Statistics
summary_stats <- data.frame(
  Statistic = c("N Methods", "Min OR", "Max OR", "Median OR", "Mean OR", "SD OR",
                "P < 0.05", "P < 0.01", "P < 0.001"),
  Value = c(nrow(results_df),
           sprintf("%.3f", min(results_df$or, na.rm = TRUE)),
           sprintf("%.3f", max(results_df$or, na.rm = TRUE)),
           sprintf("%.3f", median(results_df$or, na.rm = TRUE)),
           sprintf("%.3f", mean(results_df$or, na.rm = TRUE)),
           sprintf("%.3f", sd(results_df$or, na.rm = TRUE)),
           sum(results_df$p_value < 0.05, na.rm = TRUE),
           sum(results_df$p_value < 0.01, na.rm = TRUE),
           sum(results_df$p_value < 0.001, na.rm = TRUE))
)
addWorksheet(wb, "Summary")
writeData(wb, "Summary", summary_stats)

# Save workbook
excel_file <- file.path(export_dir, "pooled_results_complete.xlsx")
saveWorkbook(wb, excel_file, overwrite = TRUE)
log_message(paste0("Exported Excel workbook to: ", excel_file))
cat("\nExcel workbook exported to:", excel_file, "\n")
```

## Export 6: LaTeX Table

```{r export-latex}
# Create LaTeX table for publication
latex_table <- c(
  "\\begin{table}[ht]",
  "\\centering",
  "\\caption{Pooled Effect Estimates Across Propensity Score Methods}",
  "\\label{tab:ps_methods}",
  "\\begin{tabular}{lcccc}",
  "\\hline",
  "Method & OR & 95\\% CI & P-value & N \\\\",
  "\\hline"
)

for (i in 1:nrow(pub_df)) {
  sig_stars <- pub_df$Significance[i]
  latex_table <- c(latex_table,
    paste0(gsub("_", "\\\\_", pub_df$Method[i]), " & ",
           pub_df$`Odds Ratio`[i], sig_stars, " & ",
           pub_df$`95% CI`[i], " & ",
           pub_df$`P-value`[i], " & ",
           pub_df$`N Imputations`[i], " \\\\")
  )
}

latex_table <- c(latex_table,
  "\\hline",
  "\\end{tabular}",
  "\\begin{tablenotes}",
  "\\small",
  "\\item OR = Odds Ratio; CI = Confidence Interval; N = Number of imputations",
  "\\item * p < 0.05, ** p < 0.01, *** p < 0.001",
  "\\item All methods use ATT (Average Treatment Effect in the Treated) estimand",
  "\\end{tablenotes}",
  "\\end{table}"
)

# Display first few lines
cat("LaTeX table (first 15 lines):\n")
cat(paste(latex_table[1:min(15, length(latex_table))], collapse = "\n"))

# Save to file
latex_file <- file.path(export_dir, "pooled_results_table.tex")
writeLines(latex_table, latex_file)
log_message(paste0("Exported LaTeX table to: ", latex_file))
cat("\n\nLaTeX table exported to:", latex_file, "\n")
```

## Export 5: Marginal Effects Results (CSV)

```{r export-ame-csv}
if (length(pooled_mfx) > 0) {
  # Create formatted AME table
  ame_df <- do.call(rbind, lapply(names(pooled_mfx), function(sg_name) {
    res <- pooled_mfx[[sg_name]]
    if (!is.null(res) && res$success) {
      data.frame(
        subgroup = sg_name,
        subgroup_label = res$name,
        ame = res$ame,
        se = res$se,
        ci_lower = res$ci_lower,
        ci_upper = res$ci_upper,
        z_stat = res$z_stat,
        p_value = res$p_value,
        avg_n = res$avg_n,
        n_imputations = res$n_imputations,
        stringsAsFactors = FALSE
      )
    }
  }))
  
  if (!is.null(ame_df) && nrow(ame_df) > 0) {
    # Save numeric version
    ame_csv_file <- file.path(export_dir, "marginal_effects_pooled.csv")
    write.csv(ame_df, ame_csv_file, row.names = FALSE)
    log_message(paste0("Exported AME results to: ", ame_csv_file))
    
    # Create formatted version for display
    ame_formatted <- data.frame(
      Subgroup = ame_df$subgroup_label,
      AME = sprintf("%.4f", ame_df$ame),
      SE = sprintf("%.4f", ame_df$se),
      `95% CI` = sprintf("(%.4f, %.4f)", ame_df$ci_lower, ame_df$ci_upper),
      `P-value` = ifelse(ame_df$p_value < 0.001, "<0.001", sprintf("%.3f", ame_df$p_value)),
      `Avg N` = sprintf("%.0f", ame_df$avg_n),
      stringsAsFactors = FALSE,
      check.names = FALSE
    )
    
    ame_formatted_file <- file.path(export_dir, "marginal_effects_formatted.csv")
    write.csv(ame_formatted, ame_formatted_file, row.names = FALSE)
    
    # Display summary
    cat("\n", paste(rep("=", 60), collapse = ""), "\n")
    cat("MARGINAL EFFECTS EXPORT SUMMARY\n")
    cat(paste(rep("=", 60), collapse = ""), "\n\n")
    cat("Number of subgroups:", nrow(ame_df), "\n")
    cat("Overall AME:", sprintf("%.4f", ame_df$ame[ame_df$subgroup == "overall"]), "\n")
    cat("Files exported:\n")
    cat("  - marginal_effects_pooled.csv (numeric)\n")
    cat("  - marginal_effects_formatted.csv (publication-ready)\n\n")
  }
} else {
  cat("No marginal effects results to export\n")
}
```

## Export 6: Combined Results Summary

```{r export-combined}
# Create a comprehensive summary combining PS methods and AME results
if (length(pooled_results) > 0 || length(pooled_mfx) > 0) {
  combined_summary <- list()
  
  # Add PS methods summary
  if (length(pooled_results) > 0) {
    ps_summary <- data.frame(
      analysis = "PS Methods",
      method = names(pooled_results),
      estimate_type = "OR",
      estimate = sapply(pooled_results, function(x) if(x$success) x$or else NA),
      ci_lower = sapply(pooled_results, function(x) if(x$success) x$or_ci_lower else NA),
      ci_upper = sapply(pooled_results, function(x) if(x$success) x$or_ci_upper else NA),
      p_value = sapply(pooled_results, function(x) if(x$success) x$p_value else NA),
      stringsAsFactors = FALSE
    )
    combined_summary$ps_methods <- ps_summary
  }
  
  # Add AME summary
  if (length(pooled_mfx) > 0) {
    ame_summary <- data.frame(
      analysis = "Marginal Effects",
      method = names(pooled_mfx),
      estimate_type = "AME",
      estimate = sapply(pooled_mfx, function(x) if(x$success) x$ame else NA),
      ci_lower = sapply(pooled_mfx, function(x) if(x$success) x$ci_lower else NA),
      ci_upper = sapply(pooled_mfx, function(x) if(x$success) x$ci_upper else NA),
      p_value = sapply(pooled_mfx, function(x) if(x$success) x$p_value else NA),
      stringsAsFactors = FALSE
    )
    combined_summary$marginal_effects <- ame_summary
  }
  
  # Combine all results
  combined_df <- do.call(rbind, combined_summary)
  combined_file <- file.path(export_dir, "all_results_combined.csv")
  write.csv(combined_df, combined_file, row.names = FALSE)
  
  log_message(paste0("Exported combined results to: ", combined_file))
  cat("\nCombined results exported to: all_results_combined.csv\n")
}
```

## Export 7: Copy Forest Plots

```{r export-forest-plots}
# Copy forest plots to export directory if they exist
if (length(forest_plot_files) > 0) {
  cat("\n", paste(rep("=", 60), collapse = ""), "\n")
  cat("COPYING FOREST PLOTS\n")
  cat(paste(rep("=", 60), collapse = ""), "\n\n")
  
  for (plot_file in forest_plot_files) {
    dest_file <- file.path(export_dir, basename(plot_file))
    file.copy(plot_file, dest_file, overwrite = TRUE)
    cat("Copied:", basename(plot_file), "\n")
  }
  
  log_message(paste0("Copied ", length(forest_plot_files), " forest plots to export directory"))
}

# Also copy AME-specific CSV files if they exist
ame_csv_files <- c(
  file.path(marginal_effects_dir, "marginal_effects_summary.csv"),
  file.path(marginal_effects_dir, "marginal_effects_numeric.csv"),
  file.path(marginal_effects_dir, "all_imputation_results.csv")
)

for (csv_file in ame_csv_files) {
  if (file.exists(csv_file)) {
    dest_file <- file.path(export_dir, basename(csv_file))
    file.copy(csv_file, dest_file, overwrite = TRUE)
    cat("Copied:", basename(csv_file), "\n")
  }
}
```

## Forest Plot (Publication Style)

```{r forest-plot}
#| fig.width: 10
#| fig.height: 8

# Prepare data for forest plot
forest_data <- results_df[!is.na(results_df$or), ]  # Remove any failed methods

# Add method labels (clean up underscores and format nicely)
forest_data$method_label <- gsub("_", " ", forest_data$method)
forest_data$method_label <- gsub("nearest ", "Nearest Neighbor ", forest_data$method_label)
forest_data$method_label <- gsub("subclass glm", "Subclassification GLM", forest_data$method_label)
forest_data$method_label <- gsub("cbps", "CBPS", forest_data$method_label)
forest_data$method_label <- gsub("entropy", "Entropy Balancing", forest_data$method_label)
forest_data$method_label <- gsub("bart", "BART", forest_data$method_label)
forest_data$method_label <- gsub("twang gbm", "IPTW Twang GBM", forest_data$method_label)
forest_data$method_label <- gsub("glm", "GLM", forest_data$method_label)
forest_data$method_label <- gsub("gam", "GAM", forest_data$method_label)
forest_data$method_label <- gsub("gbm", "GBM", forest_data$method_label)
forest_data$method_label <- gsub("lasso", "LASSO", forest_data$method_label)
forest_data$method_label <- gsub("rpart", "RPART", forest_data$method_label)
forest_data$method_label <- gsub("mahalanobis", "Mahalanobis", forest_data$method_label)

# Add colors (blue for twang_gbm, black for others)
forest_data$color <- ifelse(forest_data$method == "twang_gbm", "blue", "black")

# Create the plot matching results-summary.Rmd style exactly
forest_plot <- ggplot(forest_data, aes(x = reorder(method_label, or), y = or, color = color)) +
  geom_pointrange(aes(ymin = or_ci_lower, ymax = or_ci_upper), size = 0.8) +
  geom_point(size = 3) +
  geom_text(aes(label = sprintf("%.2f", or), color = color), 
            vjust = -1.2, hjust = 0.5, size = 4) +
  coord_flip() +
  scale_color_identity() +
  scale_y_continuous(breaks = seq(1, max(forest_data$or_ci_upper), by = 0.1)) +
  scale_x_discrete(expand = c(0.075, 0.075)) +
  theme_minimal(base_size = 14) +
  labs(
    x = element_blank(),
    y = "Odds Ratio",
    title = "Doubly Robust Propensity Score Adjusted\n Model Estimates (ATT)",
    caption = "\n\nOdds Ratio of 1.0 = No Association.
               MatchIt, WeightIt, and twang R packages are used for estimation.
               IPTW = Inverse probability of treatment weighting.
               IPTW Twang GBM results (shown in blue) reported throughout paper."
  ) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold", margin = ggplot2::margin(b = 15)),
    legend.position = "none",
    axis.line = element_line(color = "gray80"),
    axis.text = element_text(color = "gray30"),
    axis.ticks = element_line(color = "gray80"),
    axis.title.x = element_text(margin = ggplot2::margin(t = 10)),
    plot.caption = element_text(margin = ggplot2::margin(t = 15)),
    plot.margin = ggplot2::margin(20, 20, 30, 20)
  ) +
  geom_hline(yintercept = 1, linetype = "solid", color = "gray60") +
  annotate("text", x = 0.5, y = 1, label = "Null", vjust = -1, hjust = 1.2, 
           color = "gray50", size = 3.5)

# Display the plot
print(forest_plot)

# Save the plot
forest_plot_file <- file.path(export_dir, "forest_plot_publication.png")
ggsave(
  filename = forest_plot_file,
  plot = forest_plot,
  width = 10,
  height = 8,
  dpi = 300
)

log_message(paste0("Forest plot saved to: ", forest_plot_file))
cat("\nForest plot (publication style) saved to:", forest_plot_file, "\n")
```

## File Summary

```{r file-summary}
# List all exported files
exported_files <- list.files(export_dir, full.names = FALSE)

cat("\n", paste(rep("=", 60), collapse = ""), "\n")
cat("EXPORTED FILES SUMMARY\n")
cat(paste(rep("=", 60), collapse = ""), "\n\n")

cat("Location:", export_dir, "\n\n")
cat("Files created:\n")
for (file in exported_files) {
  file_path <- file.path(export_dir, file)
  file_size <- file.info(file_path)$size
  cat(sprintf("  %-40s %8s bytes\n", file, format(file_size, big.mark = ",")))
}

cat("\nTotal files:", length(exported_files), "\n")

log_message(paste0("Export complete. Created ", length(exported_files), " files"))
```

## Session Info

```{r session-info}
log_message("Results export complete")
finalize_log(success = TRUE)
sessionInfo()
```