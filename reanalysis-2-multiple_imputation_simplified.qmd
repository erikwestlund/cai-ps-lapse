---
title: "Reanalysis Step 2: Multiple Imputation (Simplified)"
subtitle: "Run imputation and save results only"
author: "Erik Westlund"
date: "`r Sys.Date()`"
format: html
---

## Setup

```{r setup}
#| include: false
source("dependencies.R")
source("functions.R")
seed <- 2025
setup_analysis(seed = seed)

library(mice)

# ANALYSIS MODE
analysis_mode <- "final"  # "test" or "final"

if (analysis_mode == "test") {
  n_imputations <- 2
  n_iterations <- 2
} else {
  n_imputations <- 30
  n_iterations <- 20
}

# Initialize logging
log_file <- init_log("multiple_imputation_simplified")
log_message(paste0("Analysis mode: ", analysis_mode))
log_message(paste0("Imputations: ", n_imputations, ", Iterations: ", n_iterations))
```

## Load Data

```{r load-data}
df_original <- readRDS(file.path(reanalysis_data_dir, "df_for_imputation.rds"))
log_message(paste0("Loaded ", nrow(df_original), " observations"))
```

## Quick Setup for MICE

```{r setup-mice}
# Select only the core variables needed
core_vars <- c(
  # IDs
  "e_mrn_deidentified",
  
  # Outcomes
  "baseline_VA_logMAR",
  "intermediate_VA_logMAR", 
  "outcome_VA_logMAR",
  
  # Exposure
  "ever_lapse_binary",
  
  # Key covariates
  "age",
  "gender",
  "race_ethnicity_gp",
  "insurance_gp",
  "CCI",
  "DCSI",
  
  # Treatment
  "other_inject",
  "anti_VEGF",
  "focal_laser_flag",
  "PRP_flag",
  
  # Comorbidities
  "Glaucoma_bef_hitplus",
  "Otherretina_bef_hitplus",
  "cataract_surgery_bef_hitplus",
  
  # DR severity
  "No_DR",
  "NPDR", 
  "PDR",
  
  # Cohort indicator
  "cohort_id"
)

# Create dataset for MICE - use original variable names
df_mice <- df_original |>
  select(any_of(core_vars)) |>
  mutate(
    # Create person_dr from DR columns
    person_dr = case_when(
      PDR == 1 ~ 2,
      NPDR == 1 ~ 1,
      No_DR == 1 ~ 0,
      TRUE ~ NA_real_
    ),
    # Recode comorbidities
    glaucoma_cat = ifelse(Glaucoma_bef_hitplus == "Present", 1, 0),
    retina_cat = ifelse(Otherretina_bef_hitplus == "Present", 1, 0),
    cataract_cat = ifelse(cataract_surgery_bef_hitplus == 1, 1, 0)
  ) |>
  select(-No_DR, -NPDR, -PDR, -Glaucoma_bef_hitplus, -Otherretina_bef_hitplus, -cataract_surgery_bef_hitplus)

log_message(paste0("Created MICE dataset with ", ncol(df_mice), " variables"))
```

## Run MICE with Minimal Setup

```{r run-mice}
log_message("Starting MICE imputation...")

# Use default settings - let MICE decide methods
mice_results <- mice(
  df_mice,
  m = n_imputations,
  maxit = n_iterations,
  seed = seed,
  printFlag = TRUE
)

log_message("MICE imputation completed")

# Check logged events
if (!is.null(mice_results$loggedEvents)) {
  log_message("Logged events during imputation:")
  print(mice_results$loggedEvents)
}
```

## Extract and Save Complete Datasets

```{r save-results}
# Extract all imputed datasets
imputed_list <- complete(mice_results, action = "all")

# Save the mice object
saveRDS(mice_results, file.path(reanalysis_data_dir, "mice_results.rds"))
log_message(paste0("Saved MICE object to: ", file.path(reanalysis_data_dir, "mice_results.rds")))

# Save the list of complete datasets
saveRDS(imputed_list, file.path(reanalysis_data_dir, "imputed_datasets.rds"))
log_message(paste0("Saved ", length(imputed_list), " imputed datasets"))

# Also save as individual files for easier access
for (i in 1:length(imputed_list)) {
  filename <- paste0("imputed_data_", sprintf("%02d", i), ".rds")
  saveRDS(imputed_list[[i]], file.path(reanalysis_data_dir, filename))
}
log_message(paste0("Saved individual imputed datasets"))

# Create summary
summary_stats <- data.frame(
  Metric = c(
    "Original observations",
    "Variables in imputation",
    "Number of imputations",
    "Iterations per imputation",
    "Variables with missing data",
    "Total missing values"
  ),
  Value = c(
    nrow(df_mice),
    ncol(df_mice),
    n_imputations,
    n_iterations,
    sum(colSums(is.na(df_mice)) > 0),
    sum(is.na(df_mice))
  )
)

kable(summary_stats, caption = "Imputation Summary")

# Finalize logging
final_log <- finalize_log(success = TRUE)
```

**Analysis complete. Log file:** `r final_log`

## Next Steps

Run `reanalysis-3-imputation_diagnostics.qmd` to check imputation quality and plausibility.